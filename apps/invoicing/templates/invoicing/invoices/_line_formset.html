{{ formset.management_form }}
<div id="line-items">
  <table class="w-full text-sm">
    <thead class="text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
      <tr>
        <th class="px-2 py-2">Descripción</th>
        <th class="px-2 py-2 w-20">Cant.</th>
        <th class="px-2 py-2 w-24">Precio</th>
        <th class="px-2 py-2 w-20">IVA %</th>
        <th class="px-2 py-2 w-20">IRPF %</th>
        <th class="px-2 py-2 w-20">Dto. %</th>
        <th class="px-2 py-2 w-10"></th>
      </tr>
    </thead>
    <tbody id="formset-body">
      {% for line_form in formset %}
        <tr class="line-row" data-index="{{ forloop.counter0 }}">
          <td class="px-1 py-1">
            {{ line_form.id }}
            <input type="hidden" name="{{ line_form.position.html_name }}" value="{{ forloop.counter0 }}" class="position-field">
            <input type="{{ line_form.description.field.widget.input_type|default:'text' }}"
                   name="{{ line_form.description.html_name }}"
                   value="{{ line_form.description.value|default:'' }}"
                   placeholder="Descripción" class="w-full rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 py-1.5 text-sm">
          </td>
          <td class="px-1 py-1">
            <input type="number" name="{{ line_form.quantity.html_name }}" value="{{ line_form.quantity.value|default:'1' }}" step="any" class="w-full rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 py-1.5 text-sm text-right">
          </td>
          <td class="px-1 py-1">
            <input type="number" name="{{ line_form.unit_price.html_name }}" value="{{ line_form.unit_price.value|default:'' }}" step="any" class="w-full rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 py-1.5 text-sm text-right">
          </td>
          <td class="px-1 py-1">
            <input type="number" name="{{ line_form.tax_rate.html_name }}" value="{{ line_form.tax_rate.value|default:'21' }}" step="any" class="w-full rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 py-1.5 text-sm text-right">
          </td>
          <td class="px-1 py-1">
            <input type="number" name="{{ line_form.withholding_rate.html_name }}" value="{{ line_form.withholding_rate.value|default:'0' }}" step="any" class="w-full rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 py-1.5 text-sm text-right">
          </td>
          <td class="px-1 py-1">
            <input type="number" name="{{ line_form.discount_percent.html_name }}" value="{{ line_form.discount_percent.value|default:'0' }}" step="any" class="w-full rounded border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-2 py-1.5 text-sm text-right">
          </td>
          <td class="px-1 py-1 text-center">
            {% if line_form.instance.pk %}
              <label class="text-xs text-red-500 cursor-pointer" title="Eliminar">
                <input type="checkbox" name="{{ line_form.DELETE.html_name }}" class="sr-only delete-check">✕
              </label>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="flex gap-3 mt-2">
  <button type="button" id="add-line"
          class="text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100">
    + Añadir línea
  </button>
  <div class="relative" id="catalog-picker">
    <button type="button" id="catalog-btn"
            class="text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100">
      + Desde catálogo
    </button>
    <div id="catalog-dropdown" class="hidden absolute left-0 top-full mt-1 w-72 max-h-60 overflow-y-auto rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg z-10">
      <div class="p-2 text-xs text-slate-500 dark:text-slate-400">Cargando...</div>
    </div>
  </div>
</div>

<script>
// Add empty line
  document.getElementById('add-line').addEventListener('click', function() {
    addLineRow({});
  });

  function addLineRow(data) {
    const tbody = document.getElementById('formset-body');
    const totalForms = document.getElementById('id_lines-TOTAL_FORMS');
    const idx = parseInt(totalForms.value);
    const lastRow = tbody.querySelector('.line-row:last-child');
    if (!lastRow) return;
    const newRow = lastRow.cloneNode(true);
    newRow.setAttribute('data-index', idx);
    newRow.querySelectorAll('input').forEach(function(input) {
      const name = input.getAttribute('name');
      if (name) {
        const newName = name.replace(/-\d+-/, '-' + idx + '-');
        input.setAttribute('name', newName);
        const idAttr = input.getAttribute('id');
        if (idAttr) input.setAttribute('id', idAttr.replace(/-\d+-/, '-' + idx + '-'));
      // Set values based on field type
        if (input.type === 'checkbox') {
          input.checked = false;
        } else if (input.type === 'hidden') {
          if (newName.endsWith('-id')) {
            input.value = '';
          } else if (input.classList.contains('position-field')) {
            input.value = idx;
          }
        } else if (newName.endsWith('-description')) {
          input.value = data.description || '';
        } else if (newName.endsWith('-quantity')) {
          input.value = data.quantity || '1';
        } else if (newName.endsWith('-unit_price')) {
          input.value = data.unit_price || '';
        } else if (newName.endsWith('-tax_rate')) {
          input.value = data.tax_rate || '21';
        } else if (newName.endsWith('-withholding_rate')) {
          input.value = data.withholding_rate || '0';
        } else if (newName.endsWith('-discount_percent')) {
          input.value = data.discount_percent || '0';
        }
      }
    });
  // Remove delete button from cloned new row
    const deleteLabel = newRow.querySelector('.delete-check');
    if (deleteLabel) deleteLabel.parentElement.remove();
    tbody.appendChild(newRow);
    totalForms.value = idx + 1;
  }

// Catalog picker
  const catalogBtn = document.getElementById('catalog-btn');
  const catalogDropdown = document.getElementById('catalog-dropdown');
  let catalogLoaded = false;

  catalogBtn.addEventListener('click', function() {
    catalogDropdown.classList.toggle('hidden');
    if (!catalogLoaded) {
      fetch('/catalogo/json/')
        .then(r => r.json())
        .then(items => {
          catalogLoaded = true;
          if (items.length === 0) {
            catalogDropdown.innerHTML = '<div class="p-3 text-xs text-slate-500">No hay artículos en el catálogo.</div>';
            return;
          }
          let html = '';
          items.forEach(function(item) {
            html += '<button type="button" class="catalog-item w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700 last:border-0" '
            + 'data-name="' + item.name + '" '
            + 'data-desc="' + (item.description || item.name) + '" '
            + 'data-price="' + item.default_unit_price + '" '
            + 'data-tax="' + item.default_tax_rate + '" '
            + 'data-irpf="' + item.default_withholding_rate + '">'
            + '<span class="font-medium">' + item.name + '</span>'
            + '<span class="text-xs text-slate-500 ml-2">' + item.default_unit_price + ' €</span>'
            + '</button>';
          });
          catalogDropdown.innerHTML = html;
          catalogDropdown.querySelectorAll('.catalog-item').forEach(function(btn) {
            btn.addEventListener('click', function() {
              addLineRow({
                description: btn.dataset.desc,
                unit_price: btn.dataset.price,
                tax_rate: btn.dataset.tax,
                withholding_rate: btn.dataset.irpf,
              });
              catalogDropdown.classList.add('hidden');
            });
          });
        });
    }
  });

  document.addEventListener('click', function(e) {
    if (!document.getElementById('catalog-picker').contains(e.target)) {
      catalogDropdown.classList.add('hidden');
    }
  });
</script>
